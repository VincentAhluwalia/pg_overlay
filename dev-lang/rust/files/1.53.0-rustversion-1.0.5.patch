From 12efa21eb88cb43d3b927952da0c5635373ac92b Mon Sep 17 00:00:00 2001
From: David Tolnay <dtolnay@gmail.com>
Date: Thu, 17 Jun 2021 22:34:55 -0700
Subject: [PATCH] Update rustversion to 1.0.5

---
 Cargo.lock                                   |  4 +--
 vendor/rustversion/.cargo-checksum.json      |  2 +-
 vendor/rustversion/Cargo.toml                |  2 +-
 vendor/rustversion/build/build.rs            |  6 ++++
 vendor/rustversion/build/rustc.rs            | 30 +++++++++-----------
 vendor/rustversion/src/lib.rs                | 15 ++++++++++
 vendor/rustversion/src/time.rs               | 13 +++++++--
 vendor/rustversion/tests/test_parse.rs       | 10 +++++++
 vendor/rustversion/tests/ui/bad-bound.stderr |  4 +--
 vendor/rustversion/tests/ui/bad-date.stderr  |  4 +--
 10 files changed, 63 insertions(+), 27 deletions(-)

diff --git a/Cargo.lock b/Cargo.lock
index 0939f19cdfe..26a89caf050 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -4582,9 +4582,9 @@ dependencies = [
 
 [[package]]
 name = "rustversion"
-version = "1.0.4"
+version = "1.0.5"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "cb5d2a036dc6d2d8fd16fde3498b04306e29bd193bf306a57427019b823d5acd"
+checksum = "61b3909d758bb75c79f23d4736fac9433868679d3ad2ea7a61e3c25cfda9a088"
 
 [[package]]
 name = "ryu"
diff --git a/vendor/rustversion/Cargo.toml b/vendor/rustversion/Cargo.toml
index 56995ff0792..c72b1b2b343 100644
--- a/vendor/rustversion/Cargo.toml
+++ b/vendor/rustversion/Cargo.toml
@@ -13,7 +13,7 @@
 [package]
 edition = "2018"
 name = "rustversion"
-version = "1.0.4"
+version = "1.0.5"
 authors = ["David Tolnay <dtolnay@gmail.com>"]
 build = "build/build.rs"
 description = "Conditional compilation according to rustc compiler version"
diff --git a/vendor/rustversion/build/build.rs b/vendor/rustversion/build/build.rs
index 2a8bc4af39f..15312510d68 100644
--- a/vendor/rustversion/build/build.rs
+++ b/vendor/rustversion/build/build.rs
@@ -1,3 +1,9 @@
+#![allow(
+    clippy::enum_glob_use,
+    clippy::must_use_candidate,
+    clippy::single_match_else
+)]
+
 mod rustc;
 
 use std::env;
diff --git a/vendor/rustversion/build/rustc.rs b/vendor/rustversion/build/rustc.rs
index 723e6bdd0e2..dfc6a05166f 100644
--- a/vendor/rustversion/build/rustc.rs
+++ b/vendor/rustversion/build/rustc.rs
@@ -48,23 +48,21 @@ pub fn parse(string: &str) -> Option<Version> {
         Some(channel) if channel == "dev" => Dev,
         Some(channel) if channel.starts_with("beta") => Beta,
         Some(channel) if channel == "nightly" => match words.next() {
-            Some(hash) => {
-                if !hash.starts_with('(') {
-                    return None;
+            Some(hash) if hash.starts_with('(') => match words.next() {
+                None if hash.ends_with(')') => Dev,
+                Some(date) if date.ends_with(')') => {
+                    let mut date = date[..date.len() - 1].split('-');
+                    let year = date.next()?.parse().ok()?;
+                    let month = date.next()?.parse().ok()?;
+                    let day = date.next()?.parse().ok()?;
+                    match date.next() {
+                        None => Nightly(Date { year, month, day }),
+                        Some(_) => return None,
+                    }
                 }
-                let date = words.next()?;
-                if !date.ends_with(')') {
-                    return None;
-                }
-                let mut date = date[..date.len() - 1].split('-');
-                let year = date.next()?.parse().ok()?;
-                let month = date.next()?.parse().ok()?;
-                let day = date.next()?.parse().ok()?;
-                match date.next() {
-                    None => Nightly(Date { year, month, day }),
-                    Some(_) => return None,
-                }
-            }
+                None | Some(_) => return None,
+            },
+            Some(_) => return None,
             None => Dev,
         },
         Some(_) => return None,
diff --git a/vendor/rustversion/src/lib.rs b/vendor/rustversion/src/lib.rs
index 2614105dd1a..172eb89382f 100644
--- a/vendor/rustversion/src/lib.rs
+++ b/vendor/rustversion/src/lib.rs
@@ -145,6 +145,21 @@
 //!
 //! <br>
 
+#![allow(
+    clippy::cast_lossless,
+    clippy::cast_possible_truncation,
+    clippy::doc_markdown,
+    clippy::enum_glob_use,
+    clippy::from_iter_instead_of_collect,
+    clippy::module_name_repetitions,
+    clippy::must_use_candidate,
+    clippy::needless_doctest_main,
+    clippy::needless_pass_by_value,
+    clippy::redundant_else,
+    clippy::toplevel_ref_arg,
+    clippy::unreadable_literal
+)]
+
 extern crate proc_macro;
 
 mod attr;
diff --git a/vendor/rustversion/src/time.rs b/vendor/rustversion/src/time.rs
index 1e6dd9066b4..3c21463dd80 100644
--- a/vendor/rustversion/src/time.rs
+++ b/vendor/rustversion/src/time.rs
@@ -1,4 +1,5 @@
 use crate::date::Date;
+use std::env;
 use std::time::{SystemTime, UNIX_EPOCH};
 
 // Timestamp of 2016-03-01 00:00:00 in UTC.
@@ -13,14 +14,20 @@
 
 pub fn today() -> Date {
     let default = Date {
-        year: 2019,
-        month: 1,
-        day: 1,
+        year: 2020,
+        month: 2,
+        day: 25,
     };
     try_today().unwrap_or(default)
 }
 
 fn try_today() -> Option<Date> {
+    if let Some(pkg_name) = env::var_os("CARGO_PKG_NAME") {
+        if pkg_name.to_str() == Some("rustversion-tests") {
+            return None; // Stable date for ui testing.
+        }
+    }
+
     let now = SystemTime::now();
     let since_epoch = now.duration_since(UNIX_EPOCH).ok()?;
     let secs = since_epoch.as_secs();
diff --git a/vendor/rustversion/tests/test_parse.rs b/vendor/rustversion/tests/test_parse.rs
index 843bd73d3e5..cb39b3179f5 100644
--- a/vendor/rustversion/tests/test_parse.rs
+++ b/vendor/rustversion/tests/test_parse.rs
@@ -1,3 +1,5 @@
+#![allow(clippy::enum_glob_use, clippy::must_use_candidate)]
+
 include!("../build/rustc.rs");
 
 #[test]
@@ -76,6 +78,14 @@ fn test_parse() {
                 }),
             },
         ),
+        (
+            "rustc 1.52.1-nightly (gentoo)",
+            Version {
+                minor: 52,
+                patch: 1,
+                channel: Dev,
+            },
+        ),
     ];
 
     for (string, expected) in cases {
diff --git a/vendor/rustversion/tests/ui/bad-bound.stderr b/vendor/rustversion/tests/ui/bad-bound.stderr
index f8c498c8577..2c56acbdb33 100644
--- a/vendor/rustversion/tests/ui/bad-bound.stderr
+++ b/vendor/rustversion/tests/ui/bad-bound.stderr
@@ -1,10 +1,10 @@
-error: expected rustc release number like 1.31, or nightly date like 2020-10-26
+error: expected rustc release number like 1.31, or nightly date like 2020-02-25
  --> $DIR/bad-bound.rs:1:22
   |
 1 | #[rustversion::since(stable)]
   |                      ^^^^^^
 
-error: expected rustc release number like 1.31, or nightly date like 2020-10-26
+error: expected rustc release number like 1.31, or nightly date like 2020-02-25
  --> $DIR/bad-bound.rs:4:26
   |
 4 | #[rustversion::any(since(stable))]
diff --git a/vendor/rustversion/tests/ui/bad-date.stderr b/vendor/rustversion/tests/ui/bad-date.stderr
index 734d7889075..c523ccc02bf 100644
--- a/vendor/rustversion/tests/ui/bad-date.stderr
+++ b/vendor/rustversion/tests/ui/bad-date.stderr
@@ -1,10 +1,10 @@
-error: expected nightly date, like 2020-10-26
+error: expected nightly date, like 2020-02-25
  --> $DIR/bad-date.rs:1:24
   |
 1 | #[rustversion::nightly(stable)]
   |                        ^^^^^^
 
-error: expected nightly date, like 2020-10-26
+error: expected nightly date, like 2020-02-25
  --> $DIR/bad-date.rs:4:28
   |
 4 | #[rustversion::any(nightly(stable))]
-- 
2.32.0


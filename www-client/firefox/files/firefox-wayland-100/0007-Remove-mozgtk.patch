From 137f437665c51aee991c703367f3e1021d971711 Mon Sep 17 00:00:00 2001
From: Tilmann Meyer <me@atiltedtree.dev>
Date: Fri, 15 Apr 2022 14:15:12 +0200
Subject: [PATCH 07/11] Remove mozgtk

---
 browser/installer/package-manifest.in |  3 ---
 toolkit/library/moz.build             | 15 -----------
 widget/gtk/moz.build                  |  3 ---
 widget/gtk/mozgtk/moz.build           | 36 ---------------------------
 widget/gtk/mozgtk/mozgtk.c            | 21 ----------------
 5 files changed, 78 deletions(-)
 delete mode 100644 widget/gtk/mozgtk/moz.build
 delete mode 100644 widget/gtk/mozgtk/mozgtk.c

diff --git a/browser/installer/package-manifest.in b/browser/installer/package-manifest.in
index 73a41dc25b9ad..9f19db2dba4f7 100644
--- a/browser/installer/package-manifest.in
+++ b/browser/installer/package-manifest.in
@@ -103,12 +103,9 @@
 @BINPATH@/ucrtbase.dll
 #endif
 #endif
-#ifdef MOZ_GTK
-@BINPATH@/@DLL_PREFIX@mozgtk@DLL_SUFFIX@
 #ifdef MOZ_WAYLAND
 @BINPATH@/@DLL_PREFIX@mozwayland@DLL_SUFFIX@
 #endif
-#endif
 
 ; We don't have a complete view of which dlls to expect when doing an artifact
 ; build because we haven't run the relevant parts of configure, so we guess
diff --git a/toolkit/library/moz.build b/toolkit/library/moz.build
index 0f9d7e95bf46b..a1393ad6f4a13 100644
--- a/toolkit/library/moz.build
+++ b/toolkit/library/moz.build
@@ -167,21 +167,6 @@ USE_LIBS += [
 ]
 
 if CONFIG["MOZ_WIDGET_TOOLKIT"] == "gtk":
-    # The mozgtk library is a workaround that makes Gtk+ use libwayland-client
-    # instead of mozwayland. The reason it works is that by being a dependency
-    # of libxul, mozgtk appears in dependentlibs.list, preceding mozwayland
-    # (which is important and guaranteed by the USE_LIBS order in this file).
-    # That, in turn, makes firefox dlopen() mozgtk before mozwayland, which
-    # will trigger the loading of the Gtk+ libraries (mozgtk depending on them).
-    # Those libraries, if they depend on libwayland-client, will use the symbols
-    # from libwayland-client because mozwayland is not loaded yet.
-    # When eventually libxul is loaded after both mozgtk and mozwayland, it will
-    # get symbols from libwayland-client too.
-    # In the case where Gtk+ doesn't have wayland support, libwayland-client is
-    # not loaded, and libxul ends up using the mozwayland symbols.
-    USE_LIBS += [
-        "mozgtk",
-    ]
     OS_LIBS += CONFIG["MOZ_GTK3_LIBS"]
 
 if CONFIG["MOZ_WAYLAND"]:
diff --git a/widget/gtk/moz.build b/widget/gtk/moz.build
index 7b1fff94235e4..1d6aef4c07876 100644
--- a/widget/gtk/moz.build
+++ b/widget/gtk/moz.build
@@ -19,9 +19,6 @@ with Files("*IMContextWrapper*"):
 with Files("*nsGtkKeyUtils*"):
     BUG_COMPONENT = ("Core", "DOM: UI Events & Focus Handling")
 
-if CONFIG["COMPILE_ENVIRONMENT"]:
-    DIRS += ["mozgtk"]
-
 if CONFIG["MOZ_WAYLAND"]:
     DIRS += ["wayland", "mozwayland"]
 
diff --git a/widget/gtk/mozgtk/moz.build b/widget/gtk/mozgtk/moz.build
deleted file mode 100644
index f860f8217879e..0000000000000
--- a/widget/gtk/mozgtk/moz.build
+++ /dev/null
@@ -1,36 +0,0 @@
-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-
-# vim: set filetype=python:
-# This Source Code Form is subject to the terms of the Mozilla Public
-# License, v. 2.0. If a copy of the MPL was not distributed with this
-# file, You can obtain one at http://mozilla.org/MPL/2.0/.
-
-SharedLibrary("mozgtk")
-
-SOURCES += [
-    "mozgtk.c",
-]
-
-CFLAGS += CONFIG["MOZ_X11_CFLAGS"]
-
-# If LDFLAGS contains -Wl,--as-needed or if it's the default for the toolchain,
-# we need to add -Wl,--no-as-needed before the gtk libraries, otherwise the
-# linker will drop those dependencies because no symbols are used from them.
-# But those dependencies need to be kept for things to work properly.
-# Ideally, we'd only add -Wl,--no-as-needed if necessary, but it's just simpler
-# to add it unconditionally. This library is also simple enough that forcing
-# -Wl,--as-needed after the gtk libraries is not going to make a significant
-# difference.
-if CONFIG["GCC_USE_GNU_LD"]:
-    no_as_needed = ["-Wl,--no-as-needed"]
-    as_needed = ["-Wl,--as-needed"]
-else:
-    no_as_needed = []
-    as_needed = []
-
-OS_LIBS += [f for f in CONFIG["MOZ_GTK3_LIBS"] if f.startswith("-L")]
-OS_LIBS += no_as_needed
-OS_LIBS += [
-    "gtk-3",
-    "gdk-3",
-]
-OS_LIBS += as_needed
diff --git a/widget/gtk/mozgtk/mozgtk.c b/widget/gtk/mozgtk/mozgtk.c
deleted file mode 100644
index 677f9b356160a..0000000000000
--- a/widget/gtk/mozgtk/mozgtk.c
+++ /dev/null
@@ -1,21 +0,0 @@
-/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
-/* vim: set ts=8 sts=2 et sw=2 tw=80: */
-/* This Source Code Form is subject to the terms of the Mozilla Public
- * License, v. 2.0. If a copy of the MPL was not distributed with this
- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
-
-#include "mozilla/Types.h"
-
-#include <X11/Xlib.h>
-// Bug 1271100
-// We need to trick system Cairo into not using the XShm extension due to
-// a race condition in it that results in frequent BadAccess errors. Cairo
-// relies upon XShmQueryExtension to initially detect if XShm is available.
-// So we define our own stub that always indicates XShm not being present.
-// mozgtk loads before libXext/libcairo and so this stub will take priority.
-// Our tree usage goes through xcb and remains unaffected by this.
-//
-// This is also used to force libxul to depend on the mozgtk library. If we
-// ever can remove this workaround for system Cairo, we'll need something
-// to replace it for that purpose.
-MOZ_EXPORT Bool XShmQueryExtension(Display* aDisplay) { return False; }
-- 
2.35.1


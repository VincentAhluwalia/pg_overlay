From 3937f18307c267af972f74a37823ec84fafcf7dd Mon Sep 17 00:00:00 2001
From: Tilmann Meyer <me@atiltedtree.dev>
Date: Fri, 15 Apr 2022 14:19:54 +0200
Subject: [PATCH 11/11] Allow builds without X11

---
 toolkit/moz.configure | 48 ++++++++++++++++++++++++++-----------------
 1 file changed, 29 insertions(+), 19 deletions(-)

diff --git a/toolkit/moz.configure b/toolkit/moz.configure
index 7a1bb95944d8b..17733bcc28477 100644
--- a/toolkit/moz.configure
+++ b/toolkit/moz.configure
@@ -407,7 +407,7 @@ def toolkit_choices(target):
     elif target.os == "Android":
         return ("cairo-android",)
     else:
-        return ("cairo-gtk3", "cairo-gtk3-wayland")
+        return ("cairo-gtk3",)
 
 
 @depends(toolkit_choices)
@@ -459,23 +459,24 @@ def toolkit_gtk(toolkit):
 
 # Wayland support
 # ==============================================================
-wayland_headers = pkg_check_modules(
-    "MOZ_WAYLAND",
-    ["gtk+-wayland-3.0 >= 3.14", "xkbcommon >= 0.4.1", "libdrm >= 2.4", "wayland-client", "wayland-egl"],
-    allow_missing=depends(full_toolkit)(lambda t: t == "cairo-gtk3"),
-    when=depends(full_toolkit)(lambda t: t in ("cairo-gtk3", "cairo-gtk3-wayland")),
+option(
+    "--with-wayland",
+    help="{Enable wayland support|Disable wayland support}",
 )
 
-
-@depends(wayland_headers, toolkit_gtk, artifact_builds)
-def wayland_headers(wayland, toolkit_gtk, artifacts):
-    if toolkit_gtk and artifacts:
+@depends("--with-wayland", toolkit_gtk, artifact_builds)
+def with_wayland(value, toolkit_gtk, artifacts):
+    if value and toolkit_gtk or artifacts:
         return True
-    return wayland
 
+wayland_headers = pkg_check_modules(
+    "MOZ_WAYLAND",
+    ["gtk+-wayland-3.0 >= 3.14", "xkbcommon >= 0.4.1", "libdrm >= 2.4", "wayland-client", "wayland-egl"],
+    when=with_wayland,
+)
 
-set_config("MOZ_WAYLAND", depends_if(wayland_headers)(lambda _: True))
-set_define("MOZ_WAYLAND", depends_if(wayland_headers)(lambda _: True))
+set_config("MOZ_WAYLAND", True, when=with_wayland)
+set_define("MOZ_WAYLAND", True, when=with_wayland)
 
 # GL Provider
 # ==============================================================
@@ -497,7 +498,7 @@ def gl_provider_define(provider):
 set_define("MOZ_GL_PROVIDER", gl_provider_define)
 
 
-@depends(gl_provider, wayland_headers, toolkit_gtk)
+@depends(gl_provider, with_wayland, toolkit_gtk)
 def gl_default_provider(value, wayland, toolkit_gtk):
     if value:
         return value
@@ -1349,11 +1350,20 @@ set_define("MOZ_RAW", depends_if("--enable-raw")(lambda _: True))
 
 # X11
 # ==============================================================
-set_config("MOZ_X11", True, when=toolkit_gtk)
-set_define("MOZ_X11", True, when=toolkit_gtk)
+option(
+    "--with-x",
+    help="{Enable X11 support|Disable X11 support}",
+)
+
+@depends("--with-x", toolkit_gtk)
+def with_x(value, toolkit_gtk):
+    if value and toolkit_gtk:
+        return True
 
+set_config("MOZ_X11", True, when=with_x)
+set_define("MOZ_X11", True, when=with_x)
 
-@depends(webrtc, when=toolkit_gtk)
+@depends(webrtc, when=with_x)
 def x11_libs(webrtc):
     libs = [
         "x11",
@@ -1377,8 +1387,8 @@ def x11_libs(webrtc):
     return libs
 
 
-pkg_check_modules("MOZ_X11", x11_libs, when=toolkit_gtk)
-pkg_check_modules("MOZ_X11_SM", ["ice", "sm"], cflags_only=True, when=toolkit_gtk)
+pkg_check_modules("MOZ_X11", x11_libs, when=with_x)
+pkg_check_modules("MOZ_X11_SM", ["ice", "sm"], cflags_only=True, when=with_x)
 
 
 # ASan Reporter Addon
-- 
2.35.1


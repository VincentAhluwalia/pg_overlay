From feb58257983ff0a4d7c6578e97a93019aeaf6c96 Mon Sep 17 00:00:00 2001
From: Tilmann Meyer <me@atiltedtree.dev>
Date: Thu, 18 Nov 2021 19:31:01 +0100
Subject: [PATCH 18/18] allow turning on/off of X11 and wayland

---
 python/mozboot/mozboot/gentoo.py |  1 -
 toolkit/moz.configure            | 48 +++++++++++++++++++-------------
 2 files changed, 29 insertions(+), 20 deletions(-)

diff --git a/python/mozboot/mozboot/gentoo.py b/python/mozboot/mozboot/gentoo.py
index a33677a0a19f5..cb9e3dd3381cd 100644
--- a/python/mozboot/mozboot/gentoo.py
+++ b/python/mozboot/mozboot/gentoo.py
@@ -33,7 +33,6 @@ class GentooBootstrapper(LinuxBootstrapper, BaseBootstrapper):
                 "dev-libs/dbus-glib",
                 "media-sound/pulseaudio",
                 "x11-libs/gtk+:3",
-                "x11-libs/libXt",
             ]
         )
 
diff --git a/toolkit/moz.configure b/toolkit/moz.configure
index b514193512f78..2488320e3f7ec 100644
--- a/toolkit/moz.configure
+++ b/toolkit/moz.configure
@@ -285,7 +285,7 @@ def toolkit_choices(target):
     elif target.os == "Android":
         return ("cairo-android",)
     else:
-        return ("cairo-gtk3", "cairo-gtk3-wayland")
+        return ("cairo-gtk3",)
 
 
 @depends(toolkit_choices)
@@ -337,23 +337,24 @@ def toolkit_gtk(toolkit):
 
 # Wayland support
 # ==============================================================
-wayland_headers = pkg_check_modules(
-    "MOZ_WAYLAND",
-    "gtk+-wayland-3.0 >= 3.14 xkbcommon >= 0.4.1 libdrm >= 2.4",
-    allow_missing=depends(full_toolkit)(lambda t: t == "cairo-gtk3"),
-    when=depends(full_toolkit)(lambda t: t in ("cairo-gtk3", "cairo-gtk3-wayland")),
+option(
+    "--with-wayland",
+    help="{Enable wayland support|Disable wayland support}",
 )
 
-
-@depends(wayland_headers, toolkit_gtk, artifact_builds)
-def wayland_headers(wayland, toolkit_gtk, artifacts):
-    if toolkit_gtk and artifacts:
+@depends("--with-wayland", toolkit_gtk, artifact_builds)
+def with_wayland(value, toolkit_gtk, artifacts):
+    if value and toolkit_gtk or artifacts:
         return True
-    return wayland
 
+wayland_headers = pkg_check_modules(
+    "MOZ_WAYLAND",
+    "gtk+-wayland-3.0 >= 3.14 xkbcommon >= 0.4.1 libdrm >= 2.4",
+    when=with_wayland,
+)
 
-set_config("MOZ_WAYLAND", depends_if(wayland_headers)(lambda _: True))
-set_define("MOZ_WAYLAND", depends_if(wayland_headers)(lambda _: True))
+set_config("MOZ_WAYLAND", True, when=with_wayland)
+set_define("MOZ_WAYLAND", True, when=with_wayland)
 
 # GL Provider
 # ==============================================================
@@ -375,7 +376,7 @@ def gl_provider_define(provider):
 set_define("MOZ_GL_PROVIDER", gl_provider_define)
 
 
-@depends(gl_provider, wayland_headers, toolkit_gtk)
+@depends(gl_provider, with_wayland, toolkit_gtk)
 def gl_default_provider(value, wayland, toolkit_gtk):
     if value:
         return value
@@ -1195,11 +1196,20 @@ set_define("MOZ_RAW", depends_if("--enable-raw")(lambda _: True))
 
 # X11
 # ==============================================================
-set_config("MOZ_X11", True, when=toolkit_gtk)
-set_define("MOZ_X11", True, when=toolkit_gtk)
+option(
+    "--with-x",
+    help="{Enable X11 support|Disable X11 support}",
+)
+
+@depends("--with-x", toolkit_gtk)
+def with_x(value, toolkit_gtk):
+    if value and toolkit_gtk:
+        return True
 
+set_config("MOZ_X11", True, when=with_x)
+set_define("MOZ_X11", True, when=with_x)
 
-@depends(webrtc, when=toolkit_gtk)
+@depends(webrtc, when=with_x)
 def x11_libs(webrtc):
     libs = [
         "x11",
@@ -1223,8 +1233,8 @@ def x11_libs(webrtc):
     return libs
 
 
-pkg_check_modules("MOZ_X11", x11_libs, when=toolkit_gtk)
-pkg_check_modules("MOZ_X11_SM", ["ice", "sm"], cflags_only=True, when=toolkit_gtk)
+pkg_check_modules("MOZ_X11", x11_libs, when=with_x)
+pkg_check_modules("MOZ_X11_SM", ["ice", "sm"], cflags_only=True, when=with_x)
 
 
 # ASan Reporter Addon
-- 
2.35.1

